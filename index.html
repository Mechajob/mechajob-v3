<script type="module">
    // 1. IMPORT FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. CONFIG (Pastikan sesuai dengan API Key Anda)
    const firebaseConfig = {
        apiKey: "AIzaSyBrluSpKYvgZzz3CjH69SqQp81ydjqI5sI",
        authDomain: "mechajob-v3.firebaseapp.com",
        projectId: "mechajob-v3",
        storageBucket: "mechajob-v3.firebasestorage.app",
        messagingSenderId: "987474678188",
        appId: "1:987474678188:web:950ccca56653af0c51aa09"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 3. AUTH OBSERVER (Cek siapa yang login)
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userSnap = await getDoc(doc(db, "users", user.uid));
            if (userSnap.exists()) {
                const userData = userSnap.data();
                // Update Nama di UI secara dinamis
                document.querySelector(".header-section h2").innerText = userData.name.toUpperCase();
                
                // Jalankan mode sesuai data role di database
                setMode(userData.role); 
            }
        } else {
            window.location.href = "index.html"; // Lempar ke login jika tidak ada session
        }
    });

    // 4. FUNGSI SET MODE (DIPERBAIKI)
    window.setMode = async function(mode) {
        const user = auth.currentUser;
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        // CEK: Jika user 'customer' mencoba klik tombol 'mechanic' tapi belum upgrade di DB
        if (mode === 'mechanic' && userData.role === 'customer') {
            const tanya = confirm("Anda terdaftar sebagai Customer. Upgrade jadi Mekanik sekarang?");
            if (tanya) {
                await updateDoc(userRef, { role: 'mechanic' });
                alert("Selamat! Role Anda sekarang adalah MEKANIK.");
                location.reload();
            } else {
                return; // Batalkan perpindahan mode
            }
        }

        // --- Sisanya adalah logic UI yang sudah Anda buat (dikembangkan) ---
        renderUIElements(mode, userData);
    };

    function renderUIElements(mode, userData) {
        const body = document.getElementById('mainBody');
        const roleLabel = document.getElementById('userRole');
        const hCont = document.getElementById('home');
        const aCont = document.getElementById('activity');
        // ... (Gunakan logic innerHTML Anda yang lama di sini, sesuaikan dengan mode) ...
        
        if(mode === 'mechanic') {
            body.classList.add('mode-mechanic');
            document.getElementById('mechBtn').classList.add('active');
            document.getElementById('custBtn').classList.remove('active');
            roleLabel.innerText = "EXPERT MECHANIC • VERIFIED";
            // Render menu mekanik...
        } else {
            body.classList.remove('mode-mechanic');
            document.getElementById('custBtn').classList.add('active');
            document.getElementById('mechBtn').classList.remove('active');
            roleLabel.innerText = "PREMIUM MEMBER • ELITE";
            // Render menu customer...
        }
    }

    // 5. FUNGSI KIRIM ORDER (HUBUNGKAN KE FORM)
    window.handleOrder = async function(event) {
        event.preventDefault();
        const btn = event.target.querySelector('button');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MENCARI...';

        try {
            await addDoc(collection(db, "orders"), {
                customerId: auth.currentUser.uid,
                customerName: document.getElementById('nama').value,
                phone: document.getElementById('telp').value,
                vehicle: document.getElementById('type_kendaraan').value,
                issue: document.getElementById('detail_kerusakan').value,
                status: "searching",
                createdAt: serverTimestamp()
            });
            alert("Order Berhasil! Mekanik akan segera menghubungi Anda.");
            switchPage(document.getElementById('navOrder'), 'activity'); // Pindah ke tab aktivitas
        } catch (e) {
            alert("Gagal membuat order: " + e.message);
        } finally {
            btn.innerText = "CARI MEKANIK";
        }
    }

    // 6. LOGOUT
    window.handleLogout = function() {
        signOut(auth).then(() => window.location.href = "index.html");
    }

    // Global Access untuk fungsi yang dipanggil dari HTML atribut (onclick)
    window.switchPage = function(el, id) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    };

</script>
